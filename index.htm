<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Anomalia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        
        /* --- TELA DE LOGIN --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 10px; width: 350px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center;
        }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .login-btn { width: 100%; padding: 12px; background: #004085; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .login-btn:hover { background: #002752; }
        .error-msg { color: red; font-size: 14px; margin-top: 10px; display: none; }

        /* --- MODAL DE DETALHES --- */
        #detalhesModal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px;
            width: 80%; max-width: 900px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        
        /* Cabe√ßalho */
        .header { background: #fff; padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 4px solid #0056b3; }
        .header h1 { margin: 0; font-size: 24px; color: #004085; }
        
        .filter-group { display: flex; align-items: center; gap: 15px; background: #f8f9fa; padding: 10px 20px; border-radius: 8px; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-weight: 600; }

        /* KPIs */
        .kpi-container { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .kpi-card { flex: 1; min-width: 200px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 5px solid #ddd; }
        .kpi-card h3 { margin: 0 0 10px; font-size: 13px; color: #888; text-transform: uppercase; font-weight: 700; }
        .kpi-card .value { font-size: 36px; font-weight: 700; color: #2d3436; }
        .kpi-blue { border-color: #0984e3; } .kpi-red { border-color: #d63031; } .kpi-orange { border-color: #e17055; } .kpi-green { border-color: #00b894; }

        /* Gr√°ficos */
        .charts-row { display: flex; gap: 25px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-box { flex: 1; min-width: 400px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); height: 350px; }

        /* Tabela Principal */
        .table-container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
        thead { background-color: #f1f3f5; }
        th { padding: 15px; text-align: left; font-size: 13px; color: #555; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #ddd; cursor: pointer; }
        th:hover { background-color: #e9ecef; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f1f1; font-size: 14px; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }

        /* Links e Badges */
        .link-responsavel { color: #0056b3; font-weight: 600; cursor: pointer; text-decoration: none; }
        .link-responsavel:hover { text-decoration: underline; color: #003d80; }
        
        .badge { padding: 5px 10px; border-radius: 50px; font-size: 11px; font-weight: 700; display: inline-block; text-align: center; min-width: 70px; }
        .bg-pendente { background-color: #ffeaea; color: #c0392b; }
        .bg-atrasado { background-color: #fff4e6; color: #d35400; }
        .bg-emdia { background-color: #e3fcef; color: #27ae60; }
        .bg-concluido { background-color: #dfe6e9; color: #2d3436; }

        /* Tabela Modal */
        .tabela-detalhe { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .tabela-detalhe th { background: #004085; color: white; padding: 10px; font-size: 12px; }
        .tabela-detalhe td { border: 1px solid #ddd; padding: 8px; font-size: 13px; }
        .tabela-detalhe tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>üîí Acesso Restrito</h2>
            <p style="color: #666; margin-bottom: 20px;">Diretoria Executiva</p>
            <input type="text" id="user" class="login-input" placeholder="Usu√°rio" onkeypress="handleEnter(event)">
            <input type="password" id="pass" class="login-input" placeholder="Senha" onkeypress="handleEnter(event)">
            <button class="login-btn" onclick="fazerLogin()">Acessar Painel</button>
            <div id="errorMsg" class="error-msg">Credenciais inv√°lidas.</div>
        </div>
    </div>

    <div id="detalhesModal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal()">&times;</span>
            <h2 id="modalTitulo" style="color: #004085; margin-bottom: 5px;">Detalhes</h2>
            <p id="modalSubtitulo" style="color: #666; font-size: 14px; margin-bottom: 20px;"></p>
            
            <div style="overflow-x: auto;">
                <table class="tabela-detalhe">
                    <thead>
                        <tr>
                            <th width="12%">Data</th>
                            <th width="10%">Status</th>
                            <th width="30%">Motivo / Descri√ß√£o</th>
                            <th width="48%">An√°lise / Tratativa</th>
                        </tr>
                    </thead>
                    <tbody id="modalCorpo">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="dashboardContainer" style="display: none;">
        <div class="header">
            <h1>Dashboard de Anomalia <span style="display:block; font-size:14px; font-weight:normal; color:#666; margin-top:5px;">Monitoramento de Anomalias e Tratativas</span></h1>
            
            <div class="filter-group">
                <label>Vis√£o:</label>
                <select id="filtroDiretoria" onchange="alterarFiltro(this.value)">
                    <option value="TODOS">-- Geral (Admin) --</option>
                    <option value="Logistica">Log√≠stica</option>
                    <option value="Comercial">Comercial</option>
                    <option value="Gente">Gente e Gest√£o</option>
                    <option value="Financeiro">Financeiro</option>
                    <option value="Prevencao">Preven√ß√£o</option>
                </select>
                <button onclick="logout()" style="padding: 8px; cursor:pointer; background: #ddd; border:none; border-radius: 4px;">Sair</button>
            </div>
        </div>

        <div class="kpi-container">
            <div class="kpi-card kpi-blue"><h3>Total Anomalias</h3><div class="value" id="kpiTotal">0</div></div>
            <div class="kpi-card kpi-red"><h3>Pendentes</h3><div class="value" id="kpiPendente">0</div></div>
            <div class="kpi-card kpi-orange"><h3>Atrasados</h3><div class="value" id="kpiAtrasado">0</div></div>
            <div class="kpi-card kpi-green"><h3>Conclu√≠dos</h3><div class="value" id="kpiConcluido">0</div></div>
        </div>

        <div class="charts-row">
            <div class="chart-box"><canvas id="chartStatus"></canvas></div>
            <div class="chart-box"><canvas id="chartResponsavel"></canvas></div>
        </div>

        <div class="table-container">
            <h3 style="margin-top:0; color:#444;">üìã Detalhamento (Clique no nome para ver motivos)</h3>
            <table>
                <thead>
                    <tr>
                        <th onclick="ordenar('filial')">Filial <span>‚Üï</span></th>
                        <th onclick="ordenar('responsavel')">Respons√°vel <span>‚Üï</span></th>
                        <th onclick="ordenar('anomalias')" style="text-align: center;">Qtd <span>‚Üï</span></th>
                        <th onclick="ordenar('planos')" style="text-align: center;">Planos <span>‚Üï</span></th>
                        <th onclick="ordenar('status')" style="text-align: center;">Status <span>‚Üï</span></th>
                        <th onclick="ordenar('diretoria')">Diretoria <span>‚Üï</span></th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. DADOS PROCESSADOS (COM DETALHES DE MOTIVO) ---
        const dadosBanco = [{"filial": "ABC", "responsavel": "Missaid Mainardes", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "API", "responsavel": "Arildo Zago", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "API", "responsavel": "Marcos Nichelle", "anomalias": 2, "planos": 1, "status": "Atrasado", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Atrasado", "analise": "Estoque sem contagem e ajustes regulares "}, {"data": "2025-11-19", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "MCD", "responsavel": "Cleverson Kuba", "anomalias": 6, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-04", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-06", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-13", "motivo": "Solicita√ß√£o de baixa referente a vencimento", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-14", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-14", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-17", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "MCD", "responsavel": "Fabio Rogerio", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TBE", "responsavel": "Luis Fernando Feijo Ramos Junior", "anomalias": 2, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-13", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TBE", "responsavel": "Paulo Cholet", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TBL", "responsavel": "Everton Silva", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TBL", "responsavel": "Lucas Santana", "anomalias": 7, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-29", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-29", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TCA", "responsavel": "Becher Barros", "anomalias": 21, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-03", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-07", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-21", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-21", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TCA", "responsavel": "Yasmin Silva", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TCG", "responsavel": "Cleverson Kuba", "anomalias": 24, "planos": 2, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-30", "motivo": "Devolu√ß√µes", "status": "Conclu√≠do", "analise": "Anomalia ID: 32 (Aberta em: 30/10/2025)\\nDescri√ß√£o: Notas de devolu√ß√£o sem pedido do cliente. Nfs: 14824 13628 13630 14262"}, {"data": "2025-10-30", "motivo": "Devolu√ß√µes", "status": "Conclu√≠do", "analise": "Anomalia ID: 34 (Aberta em: 30/10/2025)\\nDescri√ß√£o: Notas de devolu√ß√£o sem senha. √â de suma import√¢ncia e necess√°rio que os vendedores atendam e fornecam a senha,para que o processo padr√£o seja realizado para o fornecimento de informa√ß√µes.\\n\\nUnidade: TCG | Depto: Comercial"}, {"data": "2025-10-31", "motivo": "Consumo Indevido ", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-31", "motivo": "Solicita√ß√£o de baixa referente a vencimento", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-31", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-03", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-04", "motivo": "Solicita√ß√£o de baixa referente a vencimento", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-05", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-06", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-10", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-12", "motivo": "Solicita√ß√£o de baixa referente a vencimento", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-13", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-13", "motivo": "Solicita√ß√£o de baixa referente a vencimento", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-17", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-17", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-19", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-19", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-19", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-19", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-19", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-22", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-22", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TCG", "responsavel": "Leonardo Rosa", "anomalias": 1, "planos": 1, "status": "Conclu√≠do", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-30", "motivo": "Devolu√ß√µes", "status": "Conclu√≠do", "analise": "Diverg√™ncias de informa√ß√µes nas entregas da pra√ßa Dourados - segmento varejo."}]}, {"filial": "TCV", "responsavel": "Carlos Eduardo da Silva Camargo", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TPH", "responsavel": "Laudinil Souza Penteado", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TPH", "responsavel": "Rodrigo Bertoni", "anomalias": 8, "planos": 1, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-29", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-31", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-31", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-04", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-07", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-13", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-13", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-21", "motivo": "Produtos de FEFO vencidos dentro do CD", "status": "Em Dia", "analise": "Tratando como chegamos a ter mais de 500 mil em produtos vencidos e ter mais de 300 mil em produtos a vencer nos pr√≥ximos 60 dias.\\nO FEFO, pedidos e o recebimento de mercadoria n√£o era tratado da forma correta dentro da unidade.\\nAs ind√∫strias enviavam os pedidos sem a cria√ß√£o da SIT, alteravam quantidade e mix de produtos no pedidos. Al√©m de enviar produtos sem ter o pedido por parte da antiga gest√£o. Isso gerou uma quantidade alta de produtos de baixa performance e giro dentro da unidade. Com a sa√≠da da ind√∫stria Santa Helena, ficaram mais de 10 pallets de produtos com vencimento em Novembro e Dezembro, por√©m n√£o foram tratados com anteced√™ncia.\\nA filial recebia produtos pr√≥ximos de vencer, n√£o tinha processo no recebimento.\\n"}]}, {"filial": "TSJ", "responsavel": "Ana Cristina", "anomalias": 1, "planos": 1, "status": "Em Dia", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Inadimplencia de cliente que tinha restri√ß√£o de compra", "status": "Em Dia", "analise": "1 - Por que? \\nR.: Foi liberado a venda, pois a limita√ß√£o de R$500,00 reais, tinha sido para uma compra anterior, na qual o mesmo j√° tinha quitado com a unidade\\n2 - Por que? \\nR.: Porque segue no padr√£o de venda monitora, ent√£o vendemos, monitoramos se o cliente ir√° pagar n√≥s e se for pago, vendemos de novo\\n3 - Por que ? \\nR.: Fazemos a venda monitorada para clientes que possam ter problemas de inadimplencia conosco, sendo assim, vamos monitorando os pagamentos e vendas para n√£o ter um risco maior de inadimplencia. "}]}, {"filial": "TSJ", "responsavel": "Carlos Saldanha", "anomalias": 7, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-10-30", "motivo": "Nota de Troca com Produto¬†Fora¬†do¬†Prazo", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-04", "motivo": "NF de trocas com produtos avariados", "status": "Pendente", "analise": "Sem an√°lise"}, {"data": "2025-11-18", "motivo": "Nota de Troca com Produto a mais ", "status": "Pendente", "analise": "Sem an√°lise"}]}, {"filial": "TSJ", "responsavel": "Cristiano Rodrigues", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes", "status": "Pendente", "analise": "Sem an√°lise"}]}];

        const CREDENCIAIS = {
            'admin': {pass:'admin123', view:'TODOS'},
            'ademir': {pass:'log123', view:'Logistica'},
            'saulo': {pass:'com123', view:'Comercial'},
            'ana': {pass:'rh123', view:'Gente'},
            'fagnes': {pass:'fin123', view:'Financeiro'},
            'luis': {pass:'prev123', view:'Prevencao'}
        };

        // --- 2. L√ìGICA DE LOGIN ---
        let usuarioAtual = null;
        function handleEnter(e) { if(e.key==='Enter') fazerLogin(); }
        function fazerLogin() {
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value;
            if(CREDENCIAIS[u] && CREDENCIAIS[u].pass === p) {
                usuarioAtual = CREDENCIAIS[u];
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                const sel = document.getElementById('filtroDiretoria');
                sel.value = usuarioAtual.view;
                if(usuarioAtual.view !== 'TODOS') sel.disabled = true;
                alterarFiltro(usuarioAtual.view);
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }
        function logout() { location.reload(); }

        // --- 3. L√ìGICA DO DASHBOARD ---
        let ordenacao = { col: 'anomalias', dir: 'desc' };

        function alterarFiltro(diretoria) {
            let filtrados = diretoria === 'TODOS' ? [...dadosBanco] : dadosBanco.filter(d => d.diretoria === diretoria);
            filtrados.sort((a,b) => {
                let vA = a[ordenacao.col], vB = b[ordenacao.col];
                if(typeof vA === 'string') return ordenacao.dir==='asc' ? vA.localeCompare(vB) : vB.localeCompare(vA);
                return ordenacao.dir==='asc' ? vA - vB : vB - vA;
            });
            renderizar(filtrados);
        }

        function ordenar(col) {
            ordenacao.dir = (ordenacao.col === col && ordenacao.dir === 'desc') ? 'asc' : 'desc';
            ordenacao.col = col;
            alterarFiltro(document.getElementById('filtroDiretoria').value);
        }

        function renderizar(dados) {
            // KPIs
            let total=0, pend=0, atrasado=0, conc=0;
            dados.forEach(d => {
                total += d.anomalias;
                if(d.status==='Pendente') pend+=d.anomalias;
                else if(d.status==='Atrasado') atrasado+=d.anomalias;
                else conc+=d.anomalias;
            });
            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiPendente').innerText = pend;
            document.getElementById('kpiAtrasado').innerText = atrasado;
            document.getElementById('kpiConcluido').innerText = conc;

            // Tabela
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';
            dados.forEach((d, index) => {
                let bg = d.status==='Em Dia'?'bg-emdia':(d.status==='Atrasado'?'bg-atrasado':(d.status==='Conclu√≠do'?'bg-concluido':'bg-pendente'));
                // Cria uma refer√™ncia √∫nica para o click (index no array filtrado n√£o √© seguro, melhor passar o objeto)
                // Vamos usar um truque simples: armazenar o objeto no elemento row
                let row = document.createElement('tr');
                row.innerHTML = `
                    <td><span style="font-family:monospace; font-weight:bold; color:#666;">${d.filial}</span></td>
                    <td><a class="link-responsavel" onclick='abrirDetalhes(${JSON.stringify(d)})'>${d.responsavel}</a></td>
                    <td style="text-align:center; font-weight:bold;">${d.anomalias}</td>
                    <td style="text-align:center;">${d.planos}</td>
                    <td style="text-align:center;"><span class="badge ${bg}">${d.status}</span></td>
                    <td style="color:#888; font-size:12px;">${d.diretoria}</td>
                `;
                tbody.appendChild(row);
            });

            // Gr√°ficos
            renderizarGraficos(dados);
        }

        function renderizarGraficos(dados) {
            // Status Doughnut
            let statusMap = {'Pendente':0, 'Atrasado':0, 'Em Dia':0, 'Conclu√≠do':0};
            dados.forEach(d => statusMap[d.status] += d.anomalias);
            
            let ctxS = document.getElementById('chartStatus').getContext('2d');
            if(window.chartS instanceof Chart) window.chartS.destroy();
            window.chartS = new Chart(ctxS, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusMap),
                    datasets: [{ data: Object.values(statusMap), backgroundColor: ['#d63031','#e17055','#27ae60','#636e72'] }]
                },
                options: { responsive: true, plugins: { title: {display:true, text:'Volume por Status'} } }
            });

            // Top Ofensores Bar
            let top = [...dados].sort((a,b) => b.anomalias - a.anomalias).slice(0,8);
            let ctxR = document.getElementById('chartResponsavel').getContext('2d');
            if(window.chartR instanceof Chart) window.chartR.destroy();
            window.chartR = new Chart(ctxR, {
                type: 'bar',
                data: {
                    labels: top.map(d => d.responsavel.split(' ')[0]),
                    datasets: [{ label: 'Anomalias', data: top.map(d => d.anomalias), backgroundColor: '#0984e3' }]
                },
                options: { responsive: true, plugins: { legend: {display:false}, title: {display:true, text:'Top Ofensores'} } }
            });
        }

        // --- 4. MODAL DE DETALHES ---
        function abrirDetalhes(item) {
            document.getElementById('modalTitulo').innerText = "Detalhes: " + item.responsavel;
            document.getElementById('modalSubtitulo').innerText = "Filial: " + item.filial + " | Total Anomalias: " + item.anomalias;
            
            const tbody = document.getElementById('modalCorpo');
            tbody.innerHTML = '';

            item.detalhes.forEach(det => {
                let corStatus = det.status==='Pendente'?'#d63031':(det.status==='Conclu√≠do'?'green':'#e17055');
                let row = `
                    <tr>
                        <td>${det.data}</td>
                        <td style="color:${corStatus}; font-weight:bold;">${det.status}</td>
                        <td>${det.motivo}</td>
                        <td style="color:#555;">${det.analise}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('detalhesModal').style.display = "block";
        }

        function fecharModal() {
            document.getElementById('detalhesModal').style.display = "none";
        }

        // Fecha modal se clicar fora
        window.onclick = function(event) {
            if (event.target == document.getElementById('detalhesModal')) {
                fecharModal();
            }
        }
    </script>
</body>
</html>
