<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Anomalia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; color: #333; }
        
        /* LOGIN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 10px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .login-btn { width: 100%; padding: 12px; background: #004085; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .error-msg { color: red; font-size: 14px; margin-top: 10px; display: none; }

        /* MODAL */
        #detalhesModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border-radius: 8px; width: 85%; max-width: 900px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        
        /* DASHBOARD */
        .header { background: #fff; padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 4px solid #0056b3; }
        .header h1 { margin: 0; font-size: 24px; color: #004085; }
        .filter-group { display: flex; align-items: center; gap: 15px; background: #f8f9fa; padding: 10px 20px; border-radius: 8px; }
        
        /* KPIs */
        .kpi-container { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .kpi-card { flex: 1; min-width: 200px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 5px solid #ddd; }
        .kpi-card h3 { margin: 0 0 10px; font-size: 13px; color: #888; text-transform: uppercase; font-weight: 700; }
        .kpi-card .value { font-size: 36px; font-weight: 700; color: #2d3436; }
        .kpi-blue { border-color: #0984e3; } .kpi-red { border-color: #d63031; } .kpi-orange { border-color: #e17055; } .kpi-green { border-color: #00b894; }

        /* GR√ÅFICOS E TABELAS */
        .charts-row { display: flex; gap: 25px; margin-bottom: 30px; flex-wrap: wrap; }
        .chart-box { flex: 1; min-width: 400px; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); height: 350px; }
        .table-container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); overflow-x: auto; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 800px; }
        thead { background-color: #f1f3f5; }
        th { padding: 15px; text-align: left; font-size: 13px; color: #555; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #ddd; cursor: pointer; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f1f1; font-size: 14px; vertical-align: middle; }
        tr:hover { background-color: #f8f9fa; }
        .link-responsavel { color: #0056b3; font-weight: 600; cursor: pointer; text-decoration: none; }
        .link-responsavel:hover { text-decoration: underline; }
        
        /* Badges */
        .badge { padding: 5px 10px; border-radius: 50px; font-size: 11px; font-weight: 700; display: inline-block; text-align: center; min-width: 70px; }
        .bg-pendente { background-color: #ffeaea; color: #c0392b; }
        .bg-atrasado { background-color: #fff4e6; color: #d35400; }
        .bg-emdia { background-color: #e3fcef; color: #27ae60; }
        .bg-concluido { background-color: #dfe6e9; color: #2d3436; }

        /* Tabela Modal */
        .tabela-detalhe { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .tabela-detalhe th { background: #004085; color: white; padding: 10px; font-size: 12px; }
        .tabela-detalhe td { border: 1px solid #ddd; padding: 8px; font-size: 13px; }
        .tabela-detalhe tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>üîí Login Triunfante</h2>
            <p style="color: #666; margin-bottom: 20px;">Dashboard de Anomalia</p>
            <input type="text" id="user" class="login-input" placeholder="Usu√°rio (ex: ademir)" onkeypress="handleEnter(event)">
            <input type="password" id="pass" class="login-input" placeholder="Senha" onkeypress="handleEnter(event)">
            <button class="login-btn" onclick="fazerLogin()">Entrar</button>
            <div id="errorMsg" class="error-msg">Acesso negado.</div>
        </div>
    </div>

    <div id="detalhesModal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal()">&times;</span>
            <h2 id="modalTitulo" style="color: #004085; margin-bottom: 5px;">Detalhes</h2>
            <p id="modalSubtitulo" style="color: #666; font-size: 14px; margin-bottom: 20px;"></p>
            <div style="overflow-x: auto;">
                <table class="tabela-detalhe">
                    <thead>
                        <tr>
                            <th width="15%">Data</th>
                            <th width="15%">Status</th>
                            <th width="30%">Motivo (Categorizado)</th>
                            <th width="40%">Descri√ß√£o Original / An√°lise</th>
                        </tr>
                    </thead>
                    <tbody id="modalCorpo"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="dashboardContainer" style="display: none;">
        <div class="header">
            <h1>Dashboard de Anomalia <span style="display:block; font-size:14px; font-weight:normal; color:#666; margin-top:5px;">Vis√£o Geral e Tratativas</span></h1>
            <div class="filter-group">
                <label>Vis√£o:</label>
                <select id="filtroDiretoria" onchange="alterarFiltro(this.value)">
                    <option value="TODOS">-- Admin (Vis√£o Completa) --</option>
                    <option value="Logistica">Log√≠stica</option>
                    <option value="Comercial">Comercial</option>
                    <option value="Gente">Gente e Gest√£o</option>
                    <option value="Financeiro">Financeiro</option>
                    <option value="Prevencao">Preven√ß√£o</option>
                </select>
                <button onclick="logout()" style="padding: 8px; cursor:pointer; background: #ddd; border:none; border-radius: 4px;">Sair</button>
            </div>
        </div>

        <div class="kpi-container">
            <div class="kpi-card kpi-blue"><h3>Total</h3><div class="value" id="kpiTotal">0</div></div>
            <div class="kpi-card kpi-red"><h3>Pendentes</h3><div class="value" id="kpiPendente">0</div></div>
            <div class="kpi-card kpi-orange"><h3>Atrasados</h3><div class="value" id="kpiAtrasado">0</div></div>
            <div class="kpi-card kpi-green"><h3>Conclu√≠dos</h3><div class="value" id="kpiConcluido">0</div></div>
        </div>

        <div class="charts-row">
            <div class="chart-box"><canvas id="chartStatus"></canvas></div>
            <div class="chart-box"><canvas id="chartResponsavel"></canvas></div>
        </div>

        <div class="table-container">
            <h3 style="margin-top:0; color:#444;">üìã Vis√£o por Respons√°vel</h3>
            <table>
                <thead>
                    <tr>
                        <th onclick="ordenar('filial')">Filial <span>‚Üï</span></th>
                        <th onclick="ordenar('responsavel')">Respons√°vel <span>‚Üï</span></th>
                        <th onclick="ordenar('anomalias')" style="text-align: center;">Anomalias <span>‚Üï</span></th>
                        <th onclick="ordenar('planos')" style="text-align: center;">Planos <span>‚Üï</span></th>
                        <th onclick="ordenar('status')" style="text-align: center;">Status Geral <span>‚Üï</span></th>
                        <th onclick="ordenar('diretoria')">Diretoria <span>‚Üï</span></th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo"></tbody>
            </table>
        </div>
    </div>

    <script>
        // =================================================================
        // DADOS AUTOM√ÅTICOS (Gerados a partir do CSV do Banco)
        // A coluna "motivo" foi criada automaticamente analisando a descri√ß√£o
        // =================================================================
        const dadosBanco = [{"filial": "ABC", "responsavel": "Missaid Mainardes", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Devolu√ß√£o NF 1234 cliente recusou...", "status": "Pendente"}]}, {"filial": "ABC", "responsavel": "Nei Lessak", "anomalias": 3, "planos": 2, "status": "Pendente", "diretoria": "Logistica", "detalhes": [{"data": "2025-11-14", "motivo": "Falta/Diverg√™ncia", "desc_original": "Diverg√™ncia de estoque f√≠sico CD", "status": "Pendente"}, {"data": "2025-11-15", "motivo": "Produto Vencido", "desc_original": "Produtos vencidos no pulm√£o 3", "status": "Pendente"}]}, {"filial": "API", "responsavel": "Arildo Zago", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Recusa no ato da entrega", "status": "Pendente"}]}, {"filial": "API", "responsavel": "Magno Souza", "anomalias": 1, "planos": 1, "status": "Conclu√≠do", "diretoria": "Logistica", "detalhes": [{"data": "2025-11-10", "motivo": "Outros", "desc_original": "Ajuste operacional de rota", "status": "Conclu√≠do"}]}, {"filial": "API", "responsavel": "Marcos Nichelle", "anomalias": 2, "planos": 1, "status": "Atrasado", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Produto Vencido", "desc_original": "Produtos de FEFO vencidos dentro do CD", "status": "Atrasado"}, {"data": "2025-11-19", "motivo": "Produto Vencido", "desc_original": "Vencimento pr√≥ximo sem tratativa", "status": "Pendente"}]}, {"filial": "MCD", "responsavel": "Cleverson Kuba", "anomalias": 6, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-04", "motivo": "Produto Vencido", "desc_original": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente"}, {"data": "2025-11-06", "motivo": "Produto Vencido", "desc_original": "Produtos de FEFO vencidos", "status": "Pendente"}, {"data": "2025-11-13", "motivo": "Produto Vencido", "desc_original": "Solicita√ß√£o de baixa referente a vencimento", "status": "Pendente"}, {"data": "2025-11-14", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Devolu√ß√µes cliente varejo", "status": "Pendente"}, {"data": "2025-11-17", "motivo": "Produto Vencido", "desc_original": "FEFO estourado", "status": "Pendente"}]}, {"filial": "MCD", "responsavel": "Fabio Rogerio", "anomalias": 1, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Devolu√ß√£o total carga", "status": "Pendente"}]}, {"filial": "TBE", "responsavel": "Luis Fernando Feijo Ramos Junior", "anomalias": 2, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-12", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Devolu√ß√£o parcial", "status": "Pendente"}, {"data": "2025-11-13", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Devolu√ß√£o sem nota", "status": "Pendente"}]}, {"filial": "TBL", "responsavel": "Lucas Santana", "anomalias": 7, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-29", "motivo": "Produto Vencido", "desc_original": "Nota de Troca com Produto Fora do Prazo", "status": "Pendente"}, {"data": "2025-10-30", "motivo": "Falta/Diverg√™ncia", "desc_original": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente"}]}, {"filial": "TCA", "responsavel": "Becher Barros", "anomalias": 21, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-03", "motivo": "Produto Vencido", "desc_original": "Nota de Troca com Produto Fora do Prazo", "status": "Pendente"}, {"data": "2025-11-03", "motivo": "Falta/Diverg√™ncia", "desc_original": "Nata de Troca com Produtos Faltantes no Fisico", "status": "Pendente"}]}, {"filial": "TCG", "responsavel": "Cleverson Kuba", "anomalias": 24, "planos": 2, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-30", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Notas de devolu√ß√£o sem pedido do cliente", "status": "Conclu√≠do"}, {"data": "2025-10-31", "motivo": "Avaria/Consumo", "desc_original": "Consumo Indevido na filial", "status": "Pendente"}, {"data": "2025-10-31", "motivo": "Produto Vencido", "desc_original": "Solicita√ß√£o de baixa referente a vencimento", "status": "Pendente"}]}, {"filial": "TCG", "responsavel": "Leonardo Rosa", "anomalias": 1, "planos": 1, "status": "Conclu√≠do", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-30", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Diverg√™ncias de informa√ß√µes nas entregas", "status": "Conclu√≠do"}]}, {"filial": "TCV", "responsavel": "Nei Lessak", "anomalias": 4, "planos": 3, "status": "Pendente", "diretoria": "Logistica", "detalhes": [{"data": "2025-11-10", "motivo": "Outros", "desc_original": "Problema sist√™mico", "status": "Pendente"}]}, {"filial": "TPH", "responsavel": "Rodrigo Bertoni", "anomalias": 8, "planos": 1, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-29", "motivo": "Produto Vencido", "desc_original": "Produtos de FEFO vencidos dentro do CD", "status": "Pendente"}, {"data": "2025-11-13", "motivo": "Devolu√ß√µes/Inverso", "desc_original": "Devolu√ß√£o de mercadoria", "status": "Pendente"}]}, {"filial": "TSJ", "responsavel": "Ana Cristina", "anomalias": 1, "planos": 1, "status": "Em Dia", "diretoria": "Comercial", "detalhes": [{"data": "2025-11-13", "motivo": "Financeiro/Cr√©dito", "desc_original": "Inadimplencia de cliente que tinha restri√ß√£o", "status": "Em Dia"}]}, {"filial": "TSJ", "responsavel": "Carlos Saldanha", "anomalias": 7, "planos": 0, "status": "Pendente", "diretoria": "Comercial", "detalhes": [{"data": "2025-10-30", "motivo": "Produto Vencido", "desc_original": "Nota de Troca com Produto Fora do Prazo", "status": "Pendente"}, {"data": "2025-11-04", "motivo": "Avaria/Consumo", "desc_original": "NF de trocas com produtos avariados", "status": "Pendente"}]}];

        const CREDENCIAIS = {
            'admin': {pass:'admin123', view:'TODOS'},
            'ademir': {pass:'log123', view:'Logistica'},
            'saulo': {pass:'com123', view:'Comercial'},
            'ana': {pass:'rh123', view:'Gente'},
            'fagnes': {pass:'fin123', view:'Financeiro'},
            'luis': {pass:'prev123', view:'Prevencao'}
        };

        // --- L√ìGICA DE LOGIN ---
        let usuarioAtual = null;
        function handleEnter(e) { if(e.key==='Enter') fazerLogin(); }
        function fazerLogin() {
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value;
            if(CREDENCIAIS[u] && CREDENCIAIS[u].pass === p) {
                usuarioAtual = CREDENCIAIS[u];
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                const sel = document.getElementById('filtroDiretoria');
                sel.value = usuarioAtual.view;
                if(usuarioAtual.view !== 'TODOS') {
                    sel.disabled = true;
                    sel.style.backgroundColor = '#eee';
                }
                alterarFiltro(usuarioAtual.view);
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }
        function logout() { location.reload(); }

        // --- L√ìGICA DO DASHBOARD ---
        let ordenacao = { col: 'anomalias', dir: 'desc' };

        function alterarFiltro(diretoria) {
            let filtrados = diretoria === 'TODOS' ? [...dadosBanco] : dadosBanco.filter(d => d.diretoria === diretoria);
            filtrados.sort((a,b) => {
                let vA = a[ordenacao.col], vB = b[ordenacao.col];
                if(typeof vA === 'string') return ordenacao.dir==='asc' ? vA.localeCompare(vB) : vB.localeCompare(vA);
                return ordenacao.dir==='asc' ? vA - vB : vB - vA;
            });
            renderizar(filtrados);
        }

        function ordenar(col) {
            ordenacao.dir = (ordenacao.col === col && ordenacao.dir === 'desc') ? 'asc' : 'desc';
            ordenacao.col = col;
            alterarFiltro(document.getElementById('filtroDiretoria').value);
        }

        function renderizar(dados) {
            // KPIs
            let total=0, pend=0, atrasado=0, conc=0;
            dados.forEach(d => {
                total += d.anomalias;
                if(d.status==='Pendente') pend+=d.anomalias;
                else if(d.status==='Atrasado') atrasado+=d.anomalias;
                else conc+=d.anomalias;
            });
            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiPendente').innerText = pend;
            document.getElementById('kpiAtrasado').innerText = atrasado;
            document.getElementById('kpiConcluido').innerText = conc;

            // Tabela
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';
            dados.forEach(d => {
                let bg = d.status==='Em Dia'?'bg-emdia':(d.status==='Atrasado'?'bg-atrasado':(d.status==='Conclu√≠do'?'bg-concluido':'bg-pendente'));
                let row = document.createElement('tr');
                row.innerHTML = `
                    <td><span style="font-family:monospace; font-weight:bold; color:#666;">${d.filial}</span></td>
                    <td><a class="link-responsavel" onclick='abrirDetalhes(${JSON.stringify(d)})'>${d.responsavel}</a></td>
                    <td style="text-align:center; font-weight:bold;">${d.anomalias}</td>
                    <td style="text-align:center;">${d.planos}</td>
                    <td style="text-align:center;"><span class="badge ${bg}">${d.status}</span></td>
                    <td style="color:#888; font-size:12px;">${d.diretoria}</td>
                `;
                tbody.appendChild(row);
            });
            renderizarGraficos(dados);
        }

        function renderizarGraficos(dados) {
            let statusMap = {'Pendente':0, 'Atrasado':0, 'Em Dia':0, 'Conclu√≠do':0};
            dados.forEach(d => statusMap[d.status] += d.anomalias);
            
            let ctxS = document.getElementById('chartStatus').getContext('2d');
            if(window.chartS instanceof Chart) window.chartS.destroy();
            window.chartS = new Chart(ctxS, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusMap),
                    datasets: [{ data: Object.values(statusMap), backgroundColor: ['#d63031','#e17055','#27ae60','#636e72'] }]
                },
                options: { responsive: true, plugins: { title: {display:true, text:'Status Geral'} } }
            });

            let top = [...dados].sort((a,b) => b.anomalias - a.anomalias).slice(0,8);
            let ctxR = document.getElementById('chartResponsavel').getContext('2d');
            if(window.chartR instanceof Chart) window.chartR.destroy();
            window.chartR = new Chart(ctxR, {
                type: 'bar',
                data: {
                    labels: top.map(d => d.responsavel.split(' ')[0]),
                    datasets: [{ label: 'Anomalias', data: top.map(d => d.anomalias), backgroundColor: '#0984e3' }]
                },
                options: { responsive: true, plugins: { legend: {display:false}, title: {display:true, text:'Top Ofensores'} } }
            });
        }

        // --- MODAL DETALHES ---
        function abrirDetalhes(item) {
            document.getElementById('modalTitulo').innerText = "Detalhes: " + item.responsavel;
            document.getElementById('modalSubtitulo').innerText = "Filial: " + item.filial + " | Total Anomalias: " + item.anomalias;
            const tbody = document.getElementById('modalCorpo');
            tbody.innerHTML = '';
            item.detalhes.forEach(det => {
                let corStatus = det.status==='Pendente'?'#d63031':(det.status==='Conclu√≠do'?'green':'#e17055');
                // Aqui mostramos o Motivo gen√©rico e a Descri√ß√£o original separadamente
                let row = `<tr>
                    <td>${det.data}</td>
                    <td style="color:${corStatus}; font-weight:bold;">${det.status}</td>
                    <td><span class="badge bg-concluido" style="font-size:12px;">${det.motivo}</span></td>
                    <td style="color:#555; font-size:13px;">${det.desc_original}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
            document.getElementById('detalhesModal').style.display = "block";
        }
        function fecharModal() { document.getElementById('detalhesModal').style.display = "none"; }
        window.onclick = function(event) { if (event.target == document.getElementById('detalhesModal')) fecharModal(); }
    </script>
</body>
</html>
